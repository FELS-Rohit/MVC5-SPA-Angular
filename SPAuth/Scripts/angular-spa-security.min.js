angular.module("security",[]).constant("security.urls",{site:"/",join:"/api/account/register",login:"/token",logout:"/api/account/logout",forgotPassword:"/api/account/forgotpassword",resetPassword:"/api/account/resetpassword",confirmEmail:"/api/account/confirmEmail",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",registerExternal:"/api/account/registerExternal"}).factory("security.api",["$http","security.urls",function(a,b){var c={"Content-Type":"application/x-www-form-urlencoded"},d=function(a){var b=function(a){var d,e,f,g,c="";return angular.forEach(a,function(a,h){if(a instanceof Array)for(g=0;g<a.length;++g)d=a[g],e=h+"["+g+"]",f={},f[e]=d,c+=b(f)+"&";else a instanceof Object?angular.forEach(a,function(a,d){e=h+"["+d+"]",f={},f[e]=a,c+=b(f)+"&"}):void 0!==a&&null!==a&&(c+=encodeURIComponent(h)+"="+encodeURIComponent(a)+"&")}),c.length?c.substr(0,c.length-1):c};return angular.isObject(a)&&"[object File]"!==String(a)?b(a):a},e={getUserInfo:function(c){return a({url:b.userInfo,method:"GET",headers:{Authorization:"Bearer "+c}})},login:function(e){return a({method:"POST",url:b.login,data:d(e),headers:c})},logout:function(){return a({method:"POST",url:b.logout})},register:function(c){return a({method:"POST",url:b.join,data:c})},forgotPassword:function(c){return a({method:"POST",url:b.forgotPassword,data:c})},resetPassword:function(c){return a({method:"POST",url:b.resetPassword,data:c})},confirmEmail:function(c){return a({method:"GET",url:b.confirmEmail+"?code="+encodeURIComponent(c.code)+"&userId="+encodeURIComponent(c.userId)})},changePassword:function(c){return a({method:"POST",url:b.changePassword,data:c})},getExternalLogins:function(){return a({method:"GET",url:b.externalLogins+"?returnUrl="+encodeURIComponent(b.site)+"&generateState=true",isArray:!0})},registerExternal:function(c,d){return a({method:"POST",url:b.registerExternal,data:d,headers:{Authorization:"Bearer "+c}})}};return e}]).provider("security",["security.urls",function(a){var b=this;b.registerThenLogin=!0,b.usePopups=!1,b.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"},b.apiUrls=a,b.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null},b.$get=["security.api","$q","$http","$location","$timeout",function(a,c,d,e,f){var g=null,h=function(a){var c,d,e,f,g,h,i,b={};if(null===a)return b;c=a.split("&");for(var j=0;j<c.length;j++)d=c[j],e=d.indexOf("="),-1===e?(f=d,g=null):(f=d.substr(0,e),g=d.substr(e+1)),h=decodeURIComponent(f),i=decodeURIComponent(g),b[h]=i;return b},i=function(a,b){return a&&("clear"==a?(localStorage.removeItem("accessToken"),sessionStorage.removeItem("accessToken"),delete d.defaults.headers.common.Authorization):(b?localStorage.accessToken=a:sessionStorage.accessToken=a,d.defaults.headers.common.Authorization="Bearer "+a)),sessionStorage.accessToken||localStorage.accessToken},j=function(a){return"clear"==a?(delete localStorage.redirectTarget,void 0):(a&&(localStorage.redirectTarget=a),localStorage.redirectTarget)},k=function(d,f,g){var h=c.defer();return d.error?h.reject({message:d.error}):a.getUserInfo(d.access_token).success(function(a){a.hasRegistered?(i(d.access_token,g),m.user=a,m.redirectAuthenticated(j()||b.urls.home),b.events.login&&b.events.login(m,a),h.resolve(m.user)):(m.externalUser=a,m.externalUser.access_token=d.access_token,m.externalUser.provider=f,null!=g&&(localStorage.rememberMe=g),e.path(b.urls.registerExternal),h.reject())}),h.promise},l=function(){if(-1!=e.path().indexOf("access_token")){var c=h(e.path().substring(1));if(e.path("/"),window.opener)window.opener.external_data=c,window.close();else{var d=JSON.parse(localStorage.loginProvider),f=!1;localStorage.rememberMe&&(f=JSON.parse(localStorage.rememberMe),delete localStorage.rememberMe),delete localStorage.loginProvider,k(c,d,f)}}i()&&(i(i()),a.getUserInfo(i()).success(function(a){m.user=a,b.events.reloadUser&&b.events.reloadUser(m,a)})),a.getExternalLogins().success(function(a){m.externalLogins=a})},m=this;return m.user=null,m.externalUser=null,m.externalLogins=[],m.login=function(d){var e=c.defer();return d.grant_type="password",a.login(d).success(function(a){i(a.access_token,d.rememberMe),m.user=a,m.redirectAuthenticated(j()||b.urls.home),b.events.login&&b.events.login(m,a),e.resolve(m.user)}).error(function(a){e.reject(a)}),e.promise},m.loginWithExternal=function(a,d){var e=c.defer();if(b.usePopups){var h=window.open(a.url,"frame","resizeable,height=510,width=380");f.cancel(g),g=f(function i(){if(!h.closed)return g=f(i,500),void 0;if(b.events.closeOAuthWindow&&b.events.closeOAuthWindow(m,window.external_data),"undefined"==typeof window.external_data)return e.reject(),void 0;var c=window.external_data;delete window.external_data,e.resolve(k(c,a,d.rememberMe))},500)}else null!=d&&null!=d.rememberMe&&(localStorage.rememberMe=JSON.stringify(d.rememberMe)),localStorage.loginProvider=JSON.stringify(a),window.location.href=a.url;return e.promise},m.logout=function(){var d=c.defer();return a.logout().success(function(){m.user=null,i("clear"),j("clear"),b.events.logout&&b.events.logout(m),e.path(b.urls.postLogout),d.resolve()}).error(function(a){d.reject(a)}),d.promise},m.register=function(d){var e=c.defer();return a.register(d).success(function(){b.events.register&&b.events.register(m),b.registerThenLogin?m.login(d).then(function(a){e.resolve(a)},function(a){e.reject(a)}):e.resolve()}).error(function(a){e.reject(a)}),e.promise},m.registerExternal=function(){var b=c.defer();return m.externalUser?a.registerExternal(m.externalUser.access_token,m.externalUser).success(function(){b.resolve(m.loginWithExternal(m.externalUser.provider)),m.externalUser=null}).error(function(a){b.reject(a)}):b.reject(),b.promise},m.forgotPassword=function(b){var d=c.defer();return a.forgotPassword(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},m.resetPassword=function(b){var d=c.defer();return a.resetPassword(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},m.confirmEmail=function(b){var d=c.defer();return a.confirmEmail(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},m.changePassword=function(b){var d=c.defer();return a.changePassword(b).success(function(){d.resolve()}).error(function(a){d.reject(a)}),d.promise},m.authenticate=function(a){i()||(j()||j(e.path()),a&&j(a),e.path(b.urls.login))},m.redirectAuthenticated=function(a){i()&&(j()&&j("clear"),e.path(a))},l(),m}]}]);